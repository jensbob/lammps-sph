echo               both
log                ${dname}/log.lammps
dimension          ${ndim}
units              si
atom_style         hybrid  angle meso
communicate        single vel yes
# create simulation box

#3D box
include            ${ndim}-vars.lmp
read_data           poly3d.txt
#restart.4780000
#read_restart            flow/restart.200000
special_bonds   lj 1 1 1


variable           solvent_type equal 1
group solvent      type ${solvent_type}
group polymer      type 2 3
group wall         type 4
set  group solvent meso_rho ${sdpd_rho_solvent}
set  group polymer meso_rho ${sdpd_rho_polymer}
set  group wall meso_rho ${sdpd_rho_wall}

pair_style         hybrid/overlay interchain ${h} sdpd/rhosum 1 sdpd
pair_coeff         * *    sdpd/rhosum   ${h}

pair_coeff         1 1    sdpd ${sdpd_rho_solvent} ${sdpd_c} ${sdpd_eta_s} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         1 2    sdpd ${sdpd_rho_solvent} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         1 3    sdpd ${sdpd_rho_solvent} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         1 4    sdpd ${sdpd_rho_solvent} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         2 2    sdpd ${sdpd_rho_polymer} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         2 3    sdpd ${sdpd_rho_polymer} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         2 4    sdpd ${sdpd_rho_polymer} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         3 3    sdpd ${sdpd_rho_polymer} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         3 4    sdpd ${sdpd_rho_polymer} ${sdpd_c} ${sdpd_eta_p} ${h} ${sdpd_temp} ${sdpd_background}
pair_coeff         4 4    sdpd ${sdpd_rho_solvent} ${sdpd_c} ${sdpd_eta_s} ${h} ${sdpd_temp} ${sdpd_background}

variable           threshold    equal ${Lx}*(1.0-${xtube})
pair_coeff         * *    interchain 0.0  ${r_gauss} ${threshold}
pair_coeff         3 3    interchain ${K_gauss} ${r_gauss} ${threshold}


compute            rho_peratom all meso_rho/atom
compute            e_peratom all meso_e/atom
compute            ke_peratom all ke/atom
compute            ke all ke
compute            sdpd_kin all temp
fix                integrate_fix_full all meso

# "profile" corrected temperature
compute         pTemp all temp/profile 1 1 0 y 10

# average velocity
compute vxav all reduce ave vx
variable  vx_cm atom vx-c_vxav
fix av_vx all ave/spatial 1 ${Nfreq} ${Nfreq} &
y center 0.01 v_vx_cm file vx.av ave running units reduced
dump dump_id_txt all custom ${Nfreq} ${dname}/dump*.dat &
     id type x y z &
     vx vy vz c_rho_peratom
dump dump_id_xyz all xyz ${Nfreq} ${dname}/dump*.xyz
dump dump_id_dcd all dcd ${Nfreq} ${dname}/dump.dcd

dump_modify        dump_id_txt first yes sort id pad 8
dump_modify        dump_id_xyz first yes sort id pad 8
dump_modify        dump_id_dcd first yes sort id pad 8

thermo_style       custom step c_sdpd_kin c_pTemp
thermo_modify      norm no
thermo             10
variable    velx  atom vx
variable    vely  atom vy 
variable    velxy  atom  sqrt(v_velx*v_velx+v_vely*v_vely) 
include            ${ndim}-image.lmp

variable           eps equal 0.25*${dx}
neighbor           ${eps} bin
variable           eps delete
neigh_modify       every 1
include            settimestep.lmp
timestep           ${dt}

restart 1000000    ${dname}/sdpd.restart

bond_style fene
bond_coeff 1 ${H} ${r0}  0 0

angle_style harmonic
angle_coeff 1 ${K} 180


fix                fwall wall setforce 0.0 0.0 0.0

group              flow subtract all wall
variable           var_x atom ${A_body}*${solvent_mass}
fix                kol_force flow addforce v_var_x 0.0  0.0

variable           xbuffer_real equal ${xbuffer}*${Lx}
variable           xdepos_end      equal 0.2*${xbuffer}*${Lx}
variable           yminwall equal 3*${dx}
variable           ymaxwall equal ${Ly}-4*${dx}

variable           yminevap equal 5*${dx}
variable           ymaxevap equal ${Ly}-5*${dx}

# region    for evaporation
region             rev1    block 0 ${xbuffer_real} ${yminwall} ${yminevap} 0 0 units box
region             rev2    block 0 ${xbuffer_real} ${ymaxevap} ${ymaxwall} 0 0 units box
region             rev_all union 2 rev1 rev2 units box

# region for    deposition
region             rde     block 0 ${xdepos_end} ${yminwall} ${ymaxwall} 0 0 units box

#fix                fdep flow deposit 10000000 ${solvent_type} ${nstep_del} 29494 region rde units box
#fix                fev  solvent evaporate  ${nstep_del} 1 rev_all 49892

restart            ${Nrestart} ${dname}/restart.*
run   800000
