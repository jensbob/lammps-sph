echo               both
variable           ndim string  3d
dimension          ${ndim}
units              si
atom_style         hybrid  bond meso
boundary           p p p
communicate        single vel yes
# create simulation box

#3D box
include            ${ndim}-vars.lmp
variable           sdpd_c equal 3e-1
variable           sdpd_eta equal 1.5e-2
variable           sdpd_mu  equal ${sdpd_eta}/${sdpd_rho} 
variable          h equal 2.7*${dx}
variable          gx equal 6.12
variable          Nfreq equal 1000
variable          r0       equal 1.4*${dx}
variable          H        equal 5.3e-4

region             box block 0.0 ${Lx}  0.0 ${Ly} 0.0 ${Lz} units box
read_data           poly3d.txt

special_bonds   lj 1 1 1
bond_style fene
bond_coeff 1 ${H} ${r0}  0 0


mass               1 ${sdpd_mass}
set                group all meso_rho ${sdpd_rho}


# use Tait's EOS in combination with Morris' laminar viscosity.
# We set rho_0 = 1000 kg/m^3, c = 0.1 m/s, h = 6.5e-5 m.
# The dynamic viscosity is set to 1.0e-3 Pa s, corresponding to a kinematic viscosity of 1.0e-6 m^2/s
pair_style         hybrid/overlay sph/rhosum 1 sdpd
variable           sdpd_temp index 1e9
pair_coeff         * * sph/rhosum   ${h}
pair_coeff         * *    sdpd ${sdpd_rho} ${sdpd_c} ${sdpd_eta} ${h} ${sdpd_temp}

compute            rho_peratom all meso_rho/atom
compute            e_peratom all meso_e/atom
compute            ke_peratom all ke/atom
compute            esph all reduce sum c_e_peratom
compute            ke all ke
compute            sdpd_kin all temp
variable           etot equal c_ke+c_esph



# do full time integration for shear driver and fluid, but keep walls stationary
fix                integrate_fix_full all meso

variable bodyfx atom mass*${gx}*((y>${Ly}/2.0)-(y<${Ly}/2.0))
fix reverce_periodic all addforce v_bodyfx 0.0 0.0           

# "profile" corrected temperature
#compute         pTemp all temp/profile 1 1 0 y 5

# average velocity
compute vxav all reduce ave vx
variable  vx_cm atom vx-c_vxav
fix av_vx all ave/spatial 1 ${Nfreq} ${Nfreq} &
y center 0.01 v_vx_cm file vx.av ave running units reduced

#"profile" corrected temperature
compute         pTemp all temp/profile 1 1 0 y 10

# stresses are in units of pressure*volume must be divided by per-atom
# volume to have units of stress (pressure); components of the stress
# are in the following order xx(1), yy(2), zz(3), xy(4), xz(5), yz(6)
# The {virial} keyword means include all terms except the kinetic energy {ke}.
compute stress all stress/atom virial
variable stress_pressure atom c_stress[4]-c_pTemp[4]
fix av_xy_stress all ave/spatial 1 ${Nfreq} ${Nfreq} y lower 0.01 v_stress_pressure file sxy.av units reduced ave running

variable stress_pressure atom c_stress[4]
fix av_xy_nocorr all ave/spatial 1 ${Nfreq} ${Nfreq} y lower 0.01 v_stress_pressure file sxy-nocorr.av units reduced ave running

compute stress_bond all stress/atom bond
variable vstress_bond atom c_stress_bond[4]
fix av_xy_bond all ave/spatial 1 ${Nfreq} ${Nfreq} y lower 0.01 v_vstress_bond file sxy-bond.av units reduced ave running

dump               dump_dcd all dcd 100 poly3d.dcd

dump               dump_idu all custom 10 dumpu*.dat id type xu yu zu vx vy vz c_rho_peratom
dump               dump_id  all custom 10 dump*.dat id type x y z vx vy vz c_rho_peratom
dump_modify        dump_idu   first yes
dump_modify        dump_idu   sort id
dump_modify        dump_idu   pad 8
dump_modify        dump_id   first yes
dump_modify        dump_id   sort id
dump_modify        dump_id   pad 8


thermo_style       custom step c_sdpd_kin
thermo_modify      norm no
thermo             5
dump imgDump all image 100 image.*.jpg type type atom no bond atom 5e-6 adiam 1e-5 view 30 30 zoom 3  box yes 0.01
dump_modify        imgDump pad 9


neighbor           3.0e-6 bin
include            settimestep.lmp
timestep           ${dt}
run                1000000
